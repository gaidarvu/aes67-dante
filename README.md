# Установка aes67-daemon

Установка aes67-daemon производится из репозитория common-deb

## Создание VLAN

Необходимо на коммутаторе создать отдельный VLAN "AUDIO" для multicast траффика звуковых источников, а так же настроить qos на портах входящих в вышеуказанный VLAN.

Интерфейсы, которые будут подключены к звуковому оборудованию (матрицы и данте контроллеры) включаются в "AUDIO" в ACCESS состоянии.

Интерфейсы, которые подключаются к мини-ПК с установленными демонами AES, находятся либо в состоянии TRUNK, либо в состоянии GENERAL с тэгированием трафика VLAN "AUDIO".

# Документация по Ansible-роли Install Dante

## Описание
Эта Ansible-роль предназначена для установки и настройки сервиса Dante, удаления PulseAudio, установки и конфигурации `aes67-daemon`, а также настройки сетевого взаимодействия через `netplan` и `sysctl`.

## Обзор задач

### 1. Получение сетевых настроек
Задача `Get network settings` определяет IP-адреса для различных VLAN на основе IP-адреса хоста:
- `dante_ip` — IP-адрес в сети Dante.
- `vlan30_ip` — IP-адрес в VLAN 30.
- `vlan2_ip` — IP-адрес в VLAN 2.

### 2. Удаление PulseAudio
Если хост не принадлежит группе `conference`, выполняются следующие шаги:
- `Purge PulseAudio` — Удаление пакета `pulseaudio` вместе с зависимостями.
- `Remove PulseAudio trash` — Удаление остаточных конфигурационных файлов PulseAudio.

### 3. Установка aes67-daemon
- Устанавливает пакет `aes67-daemon` указанной версии.
- После установки выполняется перезагрузка хоста.

### 4. Настройка сети через Netplan
- Копируется конфигурационный файл `netplan` в зависимости от группы хоста (`tap` или `gers`).
- После изменения конфигурации требуется перезагрузка хоста.

### 5. Копирование конфигурации aes67-daemon
- `Copy aes config` — Устанавливает конфигурационный файл `/etc/aes67-daemon/daemon.conf`.
- `Copy aes sound source` — Копирует файл `/var/lib/aes67-daemon/status.json`, если хост принадлежит группе `tap`.

### 6. Настройка PulseAudio (для группы conference)
- В файле `/etc/pulse/daemon.conf` заменяется строка `; default-sample-rate = 44100` на `default-sample-rate = 48000`.
- После изменения требуется перезагрузка хоста.

### 7. Конфигурация Systemd-сервисов
- `Make override directory` — Создает директорию `/etc/systemd/system/{{ service_name }}.service.d` для переопределения параметров systemd-сервиса.
- `Create the override configuration` — Копирует `override.conf` в созданную директорию и перезапускает сервис `Lyra`.

### 8. Настройка параметров ядра (sysctl)
Задача `Set sysctl parameters` применяет настройки ядра для группы `tap` и `gers`, включая параметры производительности и сетевого взаимодействия.
- Применяются параметры реального времени для `tap`.
- Увеличиваются буферы и настройки TCP для `gers`.
- После применения требуется перезагрузка хоста.

## Обработчики (Handlers)
- `Restart aes67-daemon service` — Перезапускает сервис `aes67-daemon`.
- `Restart Lyra service` — Перезапускает сервис `Lyra`.
- `Reboot host` — Выполняет перезагрузку хоста (таймаут 180 секунд).

## Переменные
- `service_name` — Имя сервиса, который переопределяется в systemd.
- `aes_version` — Версия пакета `aes67-daemon`, которая устанавливается.
- `octet_1`, `octet_2` — Первые два октета IP-адреса (необходимо определить в inventory).

# Инженеры

После раскатки роли инженеры настраивают коммутатор Dante и направляют звук по нужным портам

Далее на герсах, конференции и инфотабло нужно вручную создать sink и выбрать в нем нужный мультикаст, который создадут инженеры на dante коммутаторе.

После этого можно тестировать звук.
